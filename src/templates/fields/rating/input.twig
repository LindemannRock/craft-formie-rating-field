{# Register the CSS asset for front-end #}
{% do craft.app.getView().registerAssetBundle('\\lindemannrock\\formieratingfield\\web\\assets\\field\\RatingFieldAsset') %}

{# Register Google Review integration if enabled #}
{% if field.enableGoogleReview %}
    {% set googleReviewJs = field.getGoogleReviewJs() %}
    {% if googleReviewJs %}
        {% js %}
        {{ googleReviewJs|raw }}
        {% endjs %}
    {% endif %}
{% endif %}

{# Check emoji render mode setting and load web font if needed #}
{% set plugin = craft.app.plugins.getPlugin('formie-rating-field') %}
{% set emojiMode = 'system' %}
{% if plugin %}
	{% set emojiMode = field.emojiRenderMode ?? plugin.settings.defaultEmojiRenderMode ?? 'system' %}

	{# Handle backward compatibility: 'webfont' maps to 'noto-color' #}
	{% if emojiMode == 'webfont' %}
		{% set emojiMode = 'noto-color' %}
	{% endif %}

	{% if emojiMode == 'noto-color' %}
		{# Load Noto Color Emoji from Google Fonts #}
		{% do craft.app.getView().registerCssFile('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap', {
            position: constant('yii\\web\\View::POS_HEAD')
        }) %}
	{% elseif emojiMode == 'noto-simple' %}
		{# Load Noto Emoji (simple style) from Google Fonts #}
		{% do craft.app.getView().registerCssFile('https://fonts.googleapis.com/css2?family=Noto+Emoji&display=swap', {
            position: constant('yii\\web\\View::POS_HEAD')
        }) %}
	{% endif %}
{% endif %}

{# Set default variables if not provided #}
{% set name = name ?? field.handle %}
{% set value = value ?? field.defaultValue ?? null %}
{% set options = field.getRatingOptions() %}
{% set selectedLabel = '' %}
{% for option in options %}
	{% if option.value == value %}
		{% set selectedLabel = option.label matches '/^[0-9.]+$/' ? option.label : option.label|t('formie') %}
	{% endif %}
{% endfor %}

<select name="{{ field.getHtmlName() }}" id="{{ field.getHtmlId(form) }}" class="fui-select" data-rating="{{ field.ratingType }}" data-rating-size="{{ field.ratingSize }}" data-emoji-mode="{{ emojiMode }}" {% if field.showSelectedLabel %} data-rating-show-selected="true" {% endif %} {% if field.showEndpointLabels %} data-rating-show-endpoints="true" {% if field.startLabel %} data-rating-start-label="{{ field.startLabel|t('formie') }}" {% endif %} {% if field.endLabel %} data-rating-end-label="{{ field.endLabel|t('formie') }}" {% endif %} {% endif %} {% if field.singleEmojiSelection %} data-single-selection="true" {% endif %} {% if field.customLabels %} data-custom-labels="{{ field.customLabels|json_encode }}" {% endif %} {% if field.required %} required aria-required="true" {% endif %} data-field-config="{{ field.getConfigJson() }}" data-formie-rating-field="true">
	<option value="">{{ field.placeholder ?? 'Choose a rating'|t('formie') }}</option>
	{% for option in options %}
		<option value="{{ option.value }}" {% if value is not null and option.value == value %} selected {% endif %}>
			{% if option.label matches '/^[0-9.]+$/' %}
				{{ option.label }}
			{% else %}
				{{ option.label|t('formie') }}
			{% endif %}
		</option>
	{% endfor %}
</select>
