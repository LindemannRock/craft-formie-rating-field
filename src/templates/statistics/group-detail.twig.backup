{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('formie-rating-field') %}

{% set title = groupValue ~ " - " ~ "Individual Submissions"|t('formie-rating-field') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'statistics' %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set sort = craft.app.request.getParam('sort', 'dateCreated') %}
{% set dir = craft.app.request.getParam('dir', 'desc') %}

{% set crumbs = [
    { label: ratingHelper.fullName, url: url('formie-rating-field') },
    { label: 'Statistics'|t('formie-rating-field'), url: url('formie-rating-field/statistics') },
    { label: form.title, url: url('formie-rating-field/statistics/form/' ~ form.id ~ '?dateRange=' ~ dateRange ~ '&groupBy=' ~ groupBy) },
    { label: groupValue, url: url('formie-rating-field/statistics/form/' ~ form.id ~ '/group/' ~ groupValue|url_encode ~ '?dateRange=' ~ dateRange ~ '&groupBy=' ~ groupBy) }
] %}


{% block toolbar %}
	<div id="toolbar" class="flex" style="align-items: flex-end;">
		<div class="flex-grow">
			<form method="get">
				<div class="flex">
					<div class="search-container texticon flex-grow">
						<span class="texticon-icon search icon" aria-hidden="true"></span>
						<input type="text" class="clearable text fullwidth" name="search" value="{{ search }}" placeholder="{{ 'Search submissions...'|t('formie-rating-field') }}" autocomplete="off" dir="ltr" aria-label="Search" {% if search %} autofocus {% endif %}>
						<button type="button" class="clear-btn {{ search ? '' : 'hidden' }}" title="Clear search" role="button" aria-label="Clear search"></button>
						<input type="hidden" name="groupBy" value="{{ groupBy }}">
						<input type="hidden" name="dateRange" value="{{ dateRange }}">
						<input type="hidden" name="sort" value="{{ sort }}">
						<input type="hidden" name="dir" value="{{ dir }}">
					</div>
				</div>
			</form>
		</div>
		<button type="button" class="btn" onclick="window.location.reload();" title="{{ 'Refresh'|t('formie-rating-field') }}">
			<span data-icon="refresh"></span>
			{{ 'Refresh'|t('formie-rating-field') }}
		</button>
	</div>
{% endblock %}

{% block content %}
	<style>
		.page-info {
			margin: 0 12px;
			color: #596673;
		}
		.pagination {
			gap: 4px;
			align-items: center;
		}
		#toolbar.flex {
			flex-wrap: nowrap;
			gap: 8px;
		}
		#toolbar .flex-grow {
			min-width: 0;
			flex-shrink: 1;
		}
	</style>

	<div id="elements" class="elements">
		<div class="tableview tablepane">
			<table class="data fullwidth">
				<thead>
					<tr>
						<th scope="col" data-attribute="dateCreated" class="orderable {{ sort == 'dateCreated' ? 'ordered ' ~ dir : '' }}">
							<button type="button" data-sort="dateCreated">
								{{ 'Date'|t('formie-rating-field') }}
							</button>
						</th>
						<th scope="col" data-attribute="id" class="orderable {{ sort == 'id' ? 'ordered ' ~ dir : '' }}">
							<button type="button" data-sort="id">
								{{ 'Submission'|t('formie-rating-field') }}
							</button>
						</th>
						{% for formField in form.getFields() %}
							{% if formField.handle != groupBy %}
								<th scope="col" data-attribute="{{ formField.handle }}" class="orderable {{ sort == formField.handle ? 'ordered ' ~ dir : '' }}">
									<button type="button" data-sort="{{ formField.handle }}">
										{{ formField.label }}
									</button>
								</th>
							{% endif %}
						{% endfor %}
					</tr>
				</thead>
				<tbody>
					{% if submissions|length %}
						{% for submission in submissions %}
							<tr data-id="{{ submission.id }}">
								<td>{{ submission.dateCreated|datetime('short') }}</td>
								<td>
									<a class="label-link" href="{{ submission.cpEditUrl }}" target="_blank">
										<span><code>{{ submission.id }}</code></span>
									</a>
								</td>
								{% for formField in form.getFields() %}
									{% if formField.handle != groupBy %}
										{% set value = submission.getFieldValue(formField.handle) %}
										<td>
											{% if value %}
												{% if value is iterable and value is not string %}
													{{ value|join(', ') }}
												{% else %}
													{{ value|length > 100 ? value|slice(0, 100) ~ '...' : value }}
												{% endif %}
											{% else %}
												—
											{% endif %}
										</td>
									{% endif %}
								{% endfor %}
							</tr>
						{% endfor %}
					{% else %}
						<tr>
							<td colspan="100" style="text-align: center; padding: 2em;">
								{{ 'No submissions found.'|t('formie-rating-field') }}
							</td>
						</tr>
					{% endif %}
				</tbody>
			</table>
		</div>
	</div>

	<div id="footer" class="flex flex-justify">
		<div class="light">
			<div class="flex pagination">
				<nav class="flex" aria-label="submissions pagination">
					<button type="button" class="page-link prev-page {{ page <= 1 ? 'disabled' : '' }}" {{ page <= 1 ? 'disabled' : '' }} title="Previous Page"></button>
					<button type="button" class="page-link next-page {{ page >= totalPages ? 'disabled' : '' }}" {{ page >= totalPages ? 'disabled' : '' }} title="Next Page"></button>
				</nav>
				<div class="page-info">
					{% set endRange = min(offset + limit, totalItems) %}
					{% if totalItems == 0 %}
						{{ 'no submissions'|t('formie-rating-field') }}
					{% else %}
						{{ offset + 1 }} – {{ endRange }} of {{ totalItems }} {{ totalItems == 1 ? 'submission' : 'submissions' }}
					{% endif %}
				</div>
			</div>
		</div>
		<div class="flex flex-nowrap">
			<a href="{{ url('formie-rating-field/statistics/export-group', {formId: form.id, groupBy: groupBy, groupValue: groupValue, dateRange: dateRange}) }}" class="btn">
				{{ 'Export'|t('formie-rating-field') }}
			</a>
		</div>
	</div>

	<script>
// Initialize menu buttons
document.querySelectorAll('.menubtn').forEach(btn => {
	if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
		new Craft.MenuBtn(btn);
	} else if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
		new Garnish.MenuBtn(btn);
	}
});

// Clear search
const clearBtn = document.querySelector('.clear-btn');
if (clearBtn) {
	clearBtn.addEventListener('click', function () {
		const searchInput = this.previousElementSibling.previousElementSibling;
		searchInput.value = '';
		searchInput.form.submit();
	});
}

// Search on Enter
const searchInput = document.querySelector('input[name="search"]');
if (searchInput) {
	searchInput.addEventListener('keyup', function (e) {
		if (e.key === 'Enter') {
			this.form.submit();
		}
	});
}

// Sort buttons
document.querySelectorAll('th.orderable button').forEach(button => {
	button.addEventListener('click', function () {
		const sortField = this.dataset.sort;
		const currentSort = '{{ sort }}';
		const currentDir = '{{ dir }}';
		let newDir = 'asc';

		if (sortField === currentSort) {
			newDir = currentDir === 'asc' ? 'desc' : 'asc';
		}

		const url = new URL(window.location);
		url.searchParams.set('sort', sortField);
		url.searchParams.set('dir', newDir);
		url.searchParams.set('page', '1');
		window.location.href = url.toString();
	});
});

// Pagination
document.querySelector('.prev-page:not(.disabled)')?.addEventListener('click', function () {
	const url = new URL(window.location);
	url.searchParams.set('page', {{ page - 1 }});
	window.location.href = url.toString();
});

document.querySelector('.next-page:not(.disabled)')?.addEventListener('click', function () {
	const url = new URL(window.location);
	url.searchParams.set('page', {{ page + 1 }});
	window.location.href = url.toString();
});
	</script>
{% endblock %}
