{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('formie-rating-field') %}

{% set title = ratingHelper.fullName|t('formie-rating-field') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'statistics' %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set sort = craft.app.request.getParam('sort', 'totalSubmissions') %}
{% set dir = craft.app.request.getParam('dir', 'desc') %}
{# Page, limit, offset, totalPages come from controller #}

{% set crumbs = [
    { label: ratingHelper.fullName, url: url('formie-rating-field') },
    { label: 'Statistics'|t('formie-rating-field'), url: url('formie-rating-field/statistics') }
] %}

{% block toolbar %}
	<div id="toolbar" class="flex" style="align-items: flex-end;">
		<div class="flex-grow">
			<form method="get" action="{{ url('formie-rating-field/statistics') }}">
				<div class="flex">
					<div class="search-container texticon flex-grow">
						<span class="texticon-icon search icon" aria-hidden="true"></span>
						<input type="text" class="clearable text fullwidth" name="search" value="{{ search }}" placeholder="{{ 'Search forms...'|t('formie-rating-field') }}" autocomplete="off" dir="ltr" aria-label="Search" {% if search %} autofocus {% endif %}>
						<button type="button" class="clear-btn {{ search ? '' : 'hidden' }}" title="Clear search" role="button" aria-label="Clear search"></button>
						<input type="hidden" name="sort" value="{{ sort }}">
						<input type="hidden" name="dir" value="{{ dir }}">
					</div>
				</div>
			</form>
		</div>
	</div>
{% endblock %}

{% css %}
@media (max-width: 768px) {
        #new-redirect-btn .label-full {
            display: none;
        }
        #new-redirect-btn .label-short {
            display: inline;
        }
        #new-redirect-btn:before {
            margin-inline-end: 0 !important;
        }
    }
{% endcss %}

{% block content %}
	<style>
		.page-info {
			margin: 0 12px;
			color: #596673;
		}
		.checkbox-cell {
			width: 40px !important;
			text-align: center;
		}
		.pagination {
			gap: 4px;
			align-items: center;
		}
		.menu-header {
			font-size: 11px;
			text-transform: uppercase;
			color: #7c97b2;
			padding: 8px 14px 4px;
			font-weight: 600;
			letter-spacing: 0.5px;
		}
		/* Keep toolbar on one row even on smaller screens */
		#toolbar.flex {
			flex-wrap: nowrap;
			gap: 8px;
		}
		#toolbar .flex-grow {
			min-width: 0;
			flex-shrink: 1;
		}
	</style>

	<div id="elements" class="elements">
		<div class="tableview tablepane">
			<table class="data fullwidth">
				<thead>
					<tr>
						<th scope="col" data-attribute="title" class="orderable {{ sort == 'title' ? 'ordered ' ~ dir : '' }}">
							<button type="button" data-sort="title">
								{{ 'Form Name'|t('formie-rating-field') }}
							</button>
						</th>
						<th scope="col">{{ 'Handle'|t('formie-rating-field') }}</th>
						<th scope="col" data-attribute="ratingFieldCount" class="orderable {{ sort == 'ratingFieldCount' ? 'ordered ' ~ dir : '' }}">
							<button type="button" data-sort="ratingFieldCount">
								{{ 'Rating Fields'|t('formie-rating-field') }}
							</button>
						</th>
						<th scope="col" data-attribute="totalSubmissions" class="orderable {{ sort == 'totalSubmissions' ? 'ordered ' ~ dir : '' }}">
							<button type="button" data-sort="totalSubmissions">
								{{ 'Total Submissions'|t('formie-rating-field') }}
							</button>
						</th>
						<th class="thin" style="width: 60px;">{{ 'Actions'|t('formie-rating-field') }}</th>
					</tr>
				</thead>
				<tbody>
					{% if forms|length %}
						{% for item in forms %}
							<tr data-id="{{ item.form.id }}" data-name="{{ item.form.title }}">
								<td>
									<a class="label-link" href="{{ url('formie-rating-field/statistics/form/' ~ item.form.id) }}">
										<span>{{ item.form.title }}</span>
									</a>
								</td>
								<td>
									<code>{{ item.form.handle }}</code>
								</td>
								<td>{{ item.ratingFieldCount|number }}</td>
								<td>{{ item.totalSubmissions|number_format }}</td>
								<td class="thin" style="text-align: right;">
									<a href="{{ url('formie-rating-field/statistics/form/' ~ item.form.id) }}" class="btn" title="{{ 'View Statistics'|t('formie-rating-field') }}">
										{{ 'View'|t('formie-rating-field') }}
									</a>
								</td>
							</tr>
						{% endfor %}
					{% else %}
						<tr>
							<td colspan="5" style="text-align: center; padding: 2em;">
								{{ 'No forms with rating fields found.'|t('formie-rating-field') }}
							</td>
						</tr>
					{% endif %}
				</tbody>
			</table>
		</div>
	</div>

	<div id="footer" class="flex flex-justify">
		<div class="light">
			<div class="flex pagination">
				<nav class="flex" aria-label="statistics pagination">
					<button type="button" class="page-link prev-page {{ page <= 1 ? 'disabled' : '' }}" {{ page <= 1 ? 'disabled' : '' }} title="Previous Page"></button>
					<button type="button" class="page-link next-page {{ page >= totalPages ? 'disabled' : '' }}" {{ page >= totalPages ? 'disabled' : '' }} title="Next Page"></button>
				</nav>
				<div class="page-info">
					{% set endRange = min(offset + limit, totalItems) %}
					{% if totalItems == 0 %}
						{{ 'no forms'|t('formie-rating-field') }}
					{% else %}
						{{ (offset + 1)|number }} â€“ {{ endRange|number }} of {{ totalItems|number }} {{ totalItems == 1 ? 'form' : 'forms' }}
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<script>
// Initialize menu buttons
document.querySelectorAll('.menubtn').forEach(btn => {
	if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
		new Craft.MenuBtn(btn);
	} else if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
		new Garnish.MenuBtn(btn);
	}
});

// Clear search
const clearBtn = document.querySelector('.clear-btn');
if (clearBtn) {
	clearBtn.addEventListener('click', function () {
		const searchInput = this.previousElementSibling.previousElementSibling;
		searchInput.value = '';
		searchInput.form.submit();
	});
}

// Search on Enter
const searchInput = document.querySelector('input[name="search"]');
if (searchInput) {
	searchInput.addEventListener('keyup', function (e) {
		if (e.key === 'Enter') {
			this.form.submit();
		}
	});
}

// Sort buttons
document.querySelectorAll('th.orderable button').forEach(button => {
	button.addEventListener('click', function () {
		const sortField = this.dataset.sort;
		const currentSort = '{{ sort }}';
		const currentDir = '{{ dir }}';
		let newDir = 'asc';

		if (sortField === currentSort) {
			newDir = currentDir === 'asc' ? 'desc' : 'asc';
		}

		window.location.href = '?search={{ search }}&sort=' + sortField + '&dir=' + newDir + '&page=1';
	});
});

// Pagination
document.querySelector('.prev-page:not(.disabled)')?.addEventListener('click', function () {
	window.location.href = '?search={{ search }}&sort={{ sort }}&dir={{ dir }}&page={{ page - 1 }}';
});

document.querySelector('.next-page:not(.disabled)')?.addEventListener('click', function () {
	window.location.href = '?search={{ search }}&sort={{ sort }}&dir={{ dir }}&page={{ page + 1 }}';
});
	</script>
{% endblock %}
